'use strict';

var fs = require('fs'),
    path = require('path'),
    request = require('request'),
    u = require('./util'),
    cli = require('./cli'),
    req_socket;

function sendFile(file, url, callback, cookie) {

    var globalConfig = u.getGlobalConfig(),
        defaultConfig = u.getDefaultConfig(),
        proxy = globalConfig.proxy || defaultConfig.proxy || undefined;

    fs.stat(file, function(err, stat) {

        if (err) {
            return callback(err);
        }

        var Request = request({
            uri: encodeURI(url),
            method: 'POST',
            proxy: proxy,
            headers: {
                'Content-Length' : stat.size,
                'Content-Type' : 'application/octet-stream',
                'Content-Disposition' : 'attachment;filename=' + path.basename(file),
                'Cookie' : cookie
            }
        }, function(error, response, body) {

            if (error) {
                callback(error);
            }
            if (response.statusCode === 503) {
                callback("Admin server is currently unavailable.");
            }
            if (response.statusCode === 502) {
                callback('Admin server ran into a problem when processing the request.');
            }
        });

        Request.on('request', function(req) {
            req.on('socket', function(socket) {
                req_socket = socket;
            });

            var finished = false;
            req.on('drain', function() {
                if(req_socket) {
                    var p = req_socket.bytesWritten/stat.size;
                    if(p > 1) {
                        p = 1;
                    }
                    if(!finished) {
                        cli.progress(p);
                    }
                    if(p === 1) {
                        finished = true;
                    }
                } else {
                    cli.progress(1);
                }
            });
        });

        var buf = '',
            progress = '';
        Request.on('data', function(b) {
            progress += b;
            var n, line;
            while ((n = progress.indexOf('|')) !== -1) {
                if (n === 0) {
                    progress = progress.substring(1);
                } else {
                    line = progress.substring(0, n);
                    progress = progress.substring(n);
                    if (line.indexOf('{') !== 0) {
                        console.log(line);
                    } else {
                        buf += line;
                    }
                }
            }
        });
        Request.on('end', function() {
            buf += progress;
            callback(null, buf);
        });

        fs.createReadStream(file).pipe(Request);

    });

}

exports.sendFile = sendFile;



